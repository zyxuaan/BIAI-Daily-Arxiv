<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-US" }}">
  <head>
    <meta charset="utf-8">
    <title>{{ page.title | default: site.title }}</title>
    {% include mathjax.html %}
    {% seo %}
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="icon" href="{{ '/img/paper.png' | relative_url }}" type="image/png" />
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700&display=swap" as="style" type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="{{ '/assets/css/style.css?v=' | append: site.github.build_revision | relative_url }}">
    <style>
      body { 
        font-family: "Vollkorn", serif; 
        line-height: 1.6;
      }
      h1, h2, h3, h4, h5, h6 { 
        font-family: "Vollkorn", serif; 
        margin: 1em 0 0.5em 0;
      }
      
      #controls-container {
        margin-bottom: 25px; 
        padding: 20px; 
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px; 
        display: flex; 
        flex-wrap: wrap; 
        align-items: center; 
        gap: 20px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      .control-group { 
        display: flex; 
        align-items: center; 
        gap: 8px;
      }
      
      .control-group label { 
        font-weight: bold; 
        font-size: 0.9em; 
        color: #495057;
        min-width: 70px;
      }
      
      .control-group select, .control-group input {
        padding: 10px 14px; 
        border: 2px solid #ced4da; 
        border-radius: 6px;
        font-size: 0.9em; 
        background-color: #fff;
        transition: border-color 0.3s, box-shadow 0.3s;
      }
      
      .control-group select:focus, .control-group input:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }
      
      #search-input { 
        width: 300px; 
        font-family: inherit;
      }
      
      .paper-wrapper { 
        margin-bottom: 2rem; 
        padding: 1.5rem;
        background: #fff;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: box-shadow 0.3s ease;
      }
      
      .paper-wrapper:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      
      .paper-wrapper.hidden { 
        display: none; 
      }
      
      .paper-wrapper h3 {
        margin-top: 0;
        color: #2c3e50;
        border-bottom: 2px solid #ecf0f1;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }
      
      .paper-wrapper h3 a {
        color: #3498db;
        text-decoration: none;
        transition: color 0.3s ease;
      }
      
      .paper-wrapper h3 a:hover {
        color: #2980b9;
        text-decoration: underline;
      }
      
      .paper-wrapper p strong {
        color: #7f8c8d;
        font-size: 0.9em;
      }
      
      .paper-wrapper ul {
        list-style-type: none;
        padding-left: 0;
        margin: 1rem 0;
      }
      
      .paper-wrapper li {
        margin: 0.8rem 0;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f1f2f6;
      }
      
      .paper-wrapper li:last-child {
        border-bottom: none;
      }
      
      .paper-wrapper li strong {
        color: #34495e;
        margin-right: 0.5rem;
      }
      
      .no-results {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 2rem 0;
      }
      
      @media (max-width: 768px) {
        #controls-container {
          flex-direction: column;
          align-items: stretch;
          position: relative;
        }
        
        .control-group {
          justify-content: space-between;
        }
        
        #search-input {
          width: 100%;
        }
        
        .paper-wrapper {
          padding: 1rem;
        }
      }
    </style>
    {% include head-custom.html %}
  </head>
  <body>
    <a id="skip-to-content" href="#content">Skip to the content.</a>
    <header class="page-header" role="banner">
      <h1 class="project-name">{{ page.title | default: site.title }}</h1>
      <h2 class="project-tagline">{{ page.description | default: site.description }}</h2>
      {% if site.github.is_project_page %}
        <a href="{{ site.github.repository_url }}" class="btn">View on GitHub</a>
      {% endif %}
    </header>

    <main id="content" class="main-content" role="main">
      <div id="controls-container">
        <div class="control-group">
            <label for="sort-by">排序方式:</label>
            <select id="sort-by">
              <option value="date" selected>发布日期</option>
              <option value="relevance">相关度</option>
              <option value="title">标题</option>
            </select>
        </div>
        <div class="control-group">
            <label for="sort-order">排序顺序:</label>
            <select id="sort-order">
              <option value="desc" selected>降序</option>
              <option value="asc">升序</option>
            </select>
        </div>
        <div class="control-group">
            <label for="search-input">搜索:</label>
            <input type="text" id="search-input" placeholder="按关键词搜索标题、作者、摘要...">
        </div>
      </div>
      
      <div id="papers-container">
        {{ content }}
      </div>
      
      <div id="no-results" class="no-results" style="display: none;">
        <h3>未找到匹配的论文</h3>
        <p>请尝试其他关键词或清空搜索条件</p>
      </div>
      
      <script>
        //<![CDATA[
        document.addEventListener('DOMContentLoaded', function() {
            console.log('初始化论文排序和搜索功能...');
            
            const sortBySelect = document.getElementById('sort-by');
            const sortOrderSelect = document.getElementById('sort-order');
            const searchInput = document.getElementById('search-input');
            const papersContainer = document.getElementById('papers-container');
            const noResultsDiv = document.getElementById('no-results');

            if (!papersContainer) {
                console.error('找不到papers-container元素');
                return;
            }

            let papersData = [];

            function parsePaperElements() {
                console.log('解析论文元素...');
                
                let wrappers = Array.from(papersContainer.querySelectorAll('.paper-wrapper'));
                
                if (wrappers.length === 0) {
                    console.log('创建paper-wrapper元素...');
                    const h3Elements = Array.from(papersContainer.querySelectorAll('h3'));
                    
                    if (h3Elements.length === 0) {
                        console.log('分割原始内容...');
                        const contentHtml = papersContainer.innerHTML;
                        const paperSections = contentHtml.split(/(?=###\s)/g).filter(s => s.trim());
                        
                        papersContainer.innerHTML = '';
                        
                        paperSections.forEach((section, index) => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'paper-wrapper';
                            wrapper.innerHTML = section.trim();
                            papersContainer.appendChild(wrapper);
                            wrappers.push(wrapper);
                        });
                    } else {
                        h3Elements.forEach((h3, index) => {
                            let wrapper = h3.closest('.paper-wrapper');
                            if (!wrapper) {
                                wrapper = document.createElement('div');
                                wrapper.className = 'paper-wrapper';
                                
                                const elementsToWrap = [h3];
                                let nextElement = h3.nextElementSibling;
                                while (nextElement && nextElement.tagName !== 'H3') {
                                    elementsToWrap.push(nextElement);
                                    nextElement = nextElement.nextElementSibling;
                                }
                                
                                h3.parentNode.insertBefore(wrapper, h3);
                                elementsToWrap.forEach(el => wrapper.appendChild(el));
                                wrappers.push(wrapper);
                            }
                        });
                    }
                }
                
                const parsedPapers = wrappers.map((wrapper, index) => {
                    const titleEl = wrapper.querySelector('h3');
                    const titleText = titleEl ? titleEl.textContent.trim() : '论文 ' + (index + 1);
                    const fullText = wrapper.textContent.toLowerCase();
                    
                    let date = '1970-01-01';
                    
                    // Look for date in HTML comments or text
                    const dateMatch = wrapper.innerHTML.indexOf('<!--') !== -1 ? wrapper.innerHTML.match(/(\d{4}-\d{2}-\d{2})/) : null;
                    if (dateMatch) {
                        date = dateMatch[1];
                    } else {
                        const textDateMatch = wrapper.textContent.match(/(\d{4}-\d{2}-\d{2})/);
                        if (textDateMatch) {
                            date = textDateMatch[1];
                        }
                    }
                    
                    return {
                        element: wrapper,
                        title: titleText,
                        date: date,
                        fullText: fullText,
                        relevance: 0
                    };
                });
                
                console.log('解析完成，共 ' + parsedPapers.length + ' 篇论文');
                return parsedPapers;
            }

            function updateDisplay() {
                const query = searchInput.value.toLowerCase().trim();
                const sortBy = sortBySelect.value;
                const sortOrder = sortOrderSelect.value;

                let visibleCount = 0;

                papersData.forEach(paper => {
                    let isVisible = true;
                    
                    if (query !== '') {
                        const keywords = query.split(/\s+/).filter(k => k.length > 0);
                        isVisible = keywords.every(keyword => paper.fullText.includes(keyword));
                        
                        if (isVisible) {
                            paper.relevance = keywords.reduce((score, keyword) => {
                                const matches = (paper.fullText.match(new RegExp(keyword, 'g')) || []).length;
                                const titleMatches = (paper.title.toLowerCase().match(new RegExp(keyword, 'g')) || []).length;
                                return score + matches + titleMatches * 3;
                            }, 0);
                        }
                    } else {
                        paper.relevance = 0;
                    }
                    
                    paper.element.classList.toggle('hidden', !isVisible);
                    if (isVisible) visibleCount++;
                });

                if (noResultsDiv) {
                    noResultsDiv.style.display = visibleCount === 0 && query !== '' ? 'block' : 'none';
                }

                const visiblePapers = papersData.filter(p => !p.element.classList.contains('hidden'));
                
                visiblePapers.sort((a, b) => {
                    let valA, valB;
                    switch (sortBy) {
                        case 'date':
                            valA = new Date(a.date);
                            valB = new Date(b.date);
                            break;
                        case 'title':
                            valA = a.title.toLowerCase();
                            valB = b.title.toLowerCase();
                            break;
                        case 'relevance':
                            valA = a.relevance;
                            valB = b.relevance;
                            if (valA === valB) {
                                valA = new Date(a.date);
                                valB = new Date(b.date);
                            }
                            break;
                        default:
                            return 0;
                    }

                    if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
                
                visiblePapers.forEach(paper => {
                    papersContainer.appendChild(paper.element);
                });
                
                console.log('显示 ' + visibleCount + ' 篇论文，排序: ' + sortBy + ' (' + sortOrder + ')');
            }

            function setupEventListeners() {
                sortBySelect.addEventListener('change', updateDisplay);
                sortOrderSelect.addEventListener('change', updateDisplay);
                
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function() {
                        if (searchInput.value.trim() !== '') {
                            if (sortBySelect.value !== 'relevance') {
                                sortBySelect.value = 'relevance';
                            }
                        }
                        updateDisplay();
                    }, 300);
                });
                
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        searchInput.value = '';
                        sortBySelect.value = 'date';
                        updateDisplay();
                    }
                });
            }

            setTimeout(function() {
                papersData = parsePaperElements();
                if (papersData.length > 0) {
                    setupEventListeners();
                    updateDisplay();
                    console.log('初始化成功！');
                } else {
                    console.error('未找到论文数据');
                }
            }, 200);
        });
        //]]>
      </script>

      <footer class="site-footer">
        {% if site.github.is_project_page %}
          <span class="site-footer-owner"><a href="{{ site.github.repository_url }}">{{ site.github.repository_name }}</a> is maintained by <a href="{{ site.github.owner_url }}">{{ site.github.owner_name }}</a>.</span>
        {% endif %}
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>
  </body>
</html>