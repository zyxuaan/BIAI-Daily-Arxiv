<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-US" }}">
  <head>
    <meta charset="utf-8">
    <title>{{ page.title | default: site.title }}</title>
    {% include mathjax.html %}
    {% seo %}
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="icon" href="{{ '/img/paper.png' | relative_url }}" type="image/png" />
    <!-- 优化字体加载 -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" as="style" type="text/css" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="{{ '/assets/css/style.css?v=' | append: site.github.build_revision | relative_url }}">
    <style>
      /* 基础字体设置 - 优化中英文混排 */
      body { 
        font-family: 
          "Inter", 
          "Noto Sans SC", 
          -apple-system, 
          BlinkMacSystemFont, 
          "Segoe UI", 
          "PingFang SC", 
          "Hiragino Sans GB", 
          "Microsoft YaHei UI", 
          "Microsoft YaHei", 
          "Helvetica Neue", 
          Arial, 
          sans-serif;
        font-size: 16px;
        line-height: 1.7;
        font-weight: 400;
        color: #2c3e50;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }
      
      /* 标题字体层级 */
      h1, h2, h3, h4, h5, h6 { 
        font-family: 
          "Inter", 
          "Noto Sans SC", 
          -apple-system, 
          BlinkMacSystemFont, 
          "Segoe UI", 
          "PingFang SC", 
          "Hiragino Sans GB", 
          "Microsoft YaHei UI", 
          "Microsoft YaHei", 
          "Helvetica Neue", 
          Arial, 
          sans-serif;
        font-weight: 600;
        line-height: 1.4;
        margin: 1.5em 0 0.8em 0;
        color: #1a202c;
        letter-spacing: -0.025em;
      }
      
      h1 { font-size: 2.25rem; font-weight: 700; }
      h2 { font-size: 1.875rem; font-weight: 600; }
      h3 { font-size: 1.5rem; font-weight: 600; }
      h4 { font-size: 1.25rem; font-weight: 500; }
      h5 { font-size: 1.125rem; font-weight: 500; }
      h6 { font-size: 1rem; font-weight: 500; }
      
      /* 页面头部字体 */
      .page-header .project-name {
        font-size: 3rem;
        font-weight: 700;
        letter-spacing: -0.05em;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      
      .page-header .project-tagline {
        font-size: 1.25rem;
        font-weight: 400;
        opacity: 0.9;
        letter-spacing: 0.025em;
      }
      
      /* 段落和文本优化 */
      p {
        font-size: 1rem;
        line-height: 1.8;
        margin-bottom: 1.25rem;
        color: #4a5568;
      }
      
      /* 强调文本 */
      strong, b {
        font-weight: 600;
        color: #2d3748;
      }
      
      /* 链接样式 */
      a {
        color: #3182ce;
        text-decoration: none;
        transition: color 0.2s ease;
      }
      
      a:hover {
        color: #2c5282;
        text-decoration: underline;
      }
      
      /* 代码字体 */
      code, pre {
        font-family: 
          "JetBrains Mono", 
          "Fira Code", 
          "SF Mono", 
          Monaco, 
          "Cascadia Code", 
          "Roboto Mono", 
          Consolas, 
          "Courier New", 
          monospace;
        font-size: 0.875rem;
        line-height: 1.6;
      }
      
      /* 优化搜索和控制条 */
      #controls-container {
        margin-bottom: 25px; 
        padding: 20px; 
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 16px; 
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        position: sticky;
        top: 0;
        z-index: 100;
        backdrop-filter: blur(10px);
      }
      
      /* 搜索框样式 */
      .search-container {
        margin-bottom: 20px;
      }
      
      .search-container input {
        width: 100%;
        padding: 14px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 400;
        background-color: #fff;
        transition: all 0.2s ease;
        font-family: inherit;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      
      .search-container input:focus {
        outline: none;
        border-color: #3182ce;
        box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
      }
      
      .search-container input::placeholder {
        color: #a0aec0;
      }
      
      /* 排序控制行 */
      .sort-controls {
        display: flex;
        gap: 24px;
        align-items: center;
        flex-wrap: wrap;
      }
      
      .control-group { 
        display: flex; 
        align-items: center; 
        gap: 8px;
      }
      
      .control-group label { 
        font-weight: 500; 
        font-size: 0.875rem; 
        color: #4a5568;
        min-width: 70px;
        letter-spacing: 0.025em;
      }
      
      .control-group select {
        padding: 8px 12px; 
        border: 2px solid #e2e8f0; 
        border-radius: 8px;
        font-size: 0.875rem; 
        font-weight: 400;
        background-color: #fff;
        transition: all 0.2s ease;
        font-family: inherit;
        min-width: 100px;
      }
      
      .control-group select:focus {
        outline: none;
        border-color: #3182ce;
        box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
      }
      
      /* 论文卡片样式 */
      .paper-wrapper { 
        margin-bottom: 2rem; 
        padding: 2rem;
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
        transition: all 0.3s ease;
        position: relative;
      }
      
      .paper-wrapper:hover {
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        transform: translateY(-1px);
      }
      
      .paper-wrapper.hidden { 
        display: none; 
      }
      
      /* 动态序号样式 */
      .paper-number {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .paper-wrapper h3 {
        margin-top: 0;
        color: #1a202c;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
        font-size: 1.375rem;
        font-weight: 600;
        line-height: 1.3;
        padding-right: 5rem; /* 为序号留出空间 */
      }
      
      .paper-wrapper h3 a {
        color: #2b6cb0;
        text-decoration: none;
        transition: color 0.2s ease;
      }
      
      .paper-wrapper h3 a:hover {
        color: #2c5282;
        text-decoration: underline;
      }
      
      .paper-wrapper p {
        font-size: 1rem;
        line-height: 1.8;
        margin-bottom: 1.25rem;
        color: #4a5568;
      }
      
      .paper-wrapper p strong {
        color: #2d3748;
        font-size: 0.875rem;
        font-weight: 600;
        letter-spacing: 0.025em;
      }
      
      .paper-wrapper ul {
        list-style-type: none;
        padding-left: 0;
        margin: 1.5rem 0;
      }
      
      .paper-wrapper li {
        margin: 1rem 0;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.95rem;
        line-height: 1.7;
      }
      
      .paper-wrapper li:last-child {
        border-bottom: none;
      }
      
      .paper-wrapper li strong {
        color: #2d3748;
        margin-right: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
      }
      
      .no-results {
        text-align: center;
        padding: 3rem;
        color: #718096;
        background: #f7fafc;
        border-radius: 12px;
        margin: 2rem 0;
        font-size: 1rem;
      }
      
      .no-results h3 {
        color: #4a5568;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      
      /* 移动端优化 */
      @media (max-width: 768px) {
        body {
          font-size: 15px;
        }
        
        .page-header .project-name {
          font-size: 2.25rem;
        }
        
        .page-header .project-tagline {
          font-size: 1.125rem;
        }
        
        #controls-container {
          padding: 16px;
        }
        
        .sort-controls {
          flex-direction: column;
          gap: 16px;
          align-items: stretch;
        }
        
        .control-group {
          justify-content: space-between;
        }
        
        .paper-wrapper {
          padding: 1.5rem;
        }
        
        .paper-wrapper h3 {
          font-size: 1.25rem;
          padding-right: 4rem;
        }
        
        .paper-number {
          top: 0.75rem;
          right: 0.75rem;
          padding: 0.4rem 0.8rem;
          font-size: 0.75rem;
        }
        
        h1 { font-size: 2rem; }
        h2 { font-size: 1.75rem; }
        h3 { font-size: 1.375rem; }
        h4 { font-size: 1.125rem; }
      }
      
      /* 小屏幕优化 */
      @media (max-width: 480px) {
        body {
          font-size: 14px;
        }
        
        .page-header .project-name {
          font-size: 2rem;
        }
        
        .page-header .project-tagline {
          font-size: 1rem;
        }
        
        .paper-wrapper {
          padding: 1.25rem;
        }
        
        .paper-wrapper h3 {
          font-size: 1.125rem;
          padding-right: 3.5rem;
        }
        
        .paper-number {
          top: 0.5rem;
          right: 0.5rem;
          padding: 0.3rem 0.6rem;
          font-size: 0.7rem;
        }
      }
    </style>
    {% include head-custom.html %}
  </head>
  <body>
    <a id="skip-to-content" href="#content">Skip to the content.</a>
    <header class="page-header" role="banner">
      <h1 class="project-name">{{ page.title | default: site.title }}</h1>
      <h2 class="project-tagline">{{ page.description | default: site.description }}</h2>
      {% if site.github.is_project_page %}
        <a href="{{ site.github.repository_url }}" class="btn">View on GitHub</a>
      {% endif %}
    </header>

    <main id="content" class="main-content" role="main">
      <div id="controls-container">
        <!-- 搜索框 -->
        <div class="search-container">
          <input type="text" id="search-input" placeholder="🔍 按关键词搜索标题、作者、摘要...">
        </div>
        
        <!-- 排序控制 -->
        <div class="sort-controls">
          <div class="control-group">
            <label for="sort-by">排序方式:</label>
            <select id="sort-by">
              <option value="date" selected>发布日期</option>
              <option value="relevance">相关度</option>
              <option value="title">标题</option>
            </select>
          </div>
          <div class="control-group">
            <label for="sort-order">排序顺序:</label>
            <select id="sort-order">
              <option value="desc" selected>降序</option>
              <option value="asc">升序</option>
            </select>
          </div>
        </div>
      </div>
      
      <div id="papers-container">
        {{ content }}
      </div>
      
      <div id="no-results" class="no-results" style="display: none;">
        <h3>未找到匹配的论文</h3>
        <p>请尝试其他关键词或清空搜索条件</p>
      </div>
      
      <script>
        //<![CDATA[
        document.addEventListener('DOMContentLoaded', function() {
            console.log('初始化论文排序和搜索功能...');
            
            const sortBySelect = document.getElementById('sort-by');
            const sortOrderSelect = document.getElementById('sort-order');
            const searchInput = document.getElementById('search-input');
            const papersContainer = document.getElementById('papers-container');
            const noResultsDiv = document.getElementById('no-results');

            if (!papersContainer) {
                console.error('找不到papers-container元素');
                return;
            }

            let papersData = [];

            function parsePaperElements() {
                console.log('解析论文元素...');
                
                let wrappers = Array.from(papersContainer.querySelectorAll('.paper-wrapper'));
                
                if (wrappers.length === 0) {
                    console.log('创建paper-wrapper元素...');
                    const h3Elements = Array.from(papersContainer.querySelectorAll('h3'));
                    
                    if (h3Elements.length === 0) {
                        console.log('分割原始内容...');
                        const contentHtml = papersContainer.innerHTML;
                        // 使用更灵活的正则表达式来分割内容
                        const paperSections = contentHtml.split(/(?=###\s*(?:\d+\.\s*)?)/g).filter(s => s.trim());
                        
                        papersContainer.innerHTML = '';
                        
                        paperSections.forEach((section, index) => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'paper-wrapper';
                            wrapper.innerHTML = section.trim();
                            papersContainer.appendChild(wrapper);
                            wrappers.push(wrapper);
                        });
                    } else {
                        h3Elements.forEach((h3, index) => {
                            let wrapper = h3.closest('.paper-wrapper');
                            if (!wrapper) {
                                wrapper = document.createElement('div');
                                wrapper.className = 'paper-wrapper';
                                
                                const elementsToWrap = [h3];
                                let nextElement = h3.nextElementSibling;
                                while (nextElement && nextElement.tagName !== 'H3') {
                                    elementsToWrap.push(nextElement);
                                    nextElement = nextElement.nextElementSibling;
                                }
                                
                                h3.parentNode.insertBefore(wrapper, h3);
                                elementsToWrap.forEach(el => wrapper.appendChild(el));
                                wrappers.push(wrapper);
                            }
                        });
                    }
                }
                
                const parsedPapers = wrappers.map((wrapper, index) => {
                    const titleEl = wrapper.querySelector('h3');
                    let titleText = titleEl ? titleEl.textContent.trim() : '论文 ' + (index + 1);
                    
                    // 移除标题中的序号（如果存在）
                    titleText = titleText.replace(/^\d+\.\s*/, '');
                    
                    const fullText = wrapper.textContent.toLowerCase();
                    
                    let date = '1970-01-01';
                    
                    // Look for date in HTML comments or text
                    const dateMatch = wrapper.innerHTML.indexOf('<!--') !== -1 ? wrapper.innerHTML.match(/(\d{4}-\d{2}-\d{2})/) : null;
                    if (dateMatch) {
                        date = dateMatch[1];
                    } else {
                        const textDateMatch = wrapper.textContent.match(/(\d{4}-\d{2}-\d{2})/);
                        if (textDateMatch) {
                            date = textDateMatch[1];
                        }
                    }
                    
                    return {
                        element: wrapper,
                        title: titleText,
                        date: date,
                        fullText: fullText,
                        relevance: 0
                    };
                });
                
                console.log('解析完成，共 ' + parsedPapers.length + ' 篇论文');
                return parsedPapers;
            }

            function updatePaperNumbers() {
                // 更新可见论文的序号
                const visiblePapers = papersData.filter(paper => !paper.element.classList.contains('hidden'));
                
                visiblePapers.forEach((paper, index) => {
                    // 移除旧的序号元素
                    const oldNumber = paper.element.querySelector('.paper-number');
                    if (oldNumber) {
                        oldNumber.remove();
                    }
                    
                    // 添加新的序号元素
                    const numberEl = document.createElement('div');
                    numberEl.className = 'paper-number';
                    numberEl.textContent = index + 1;
                    paper.element.appendChild(numberEl);
                    
                    // 更新标题中的序号（如果标题是H3）
                    const titleEl = paper.element.querySelector('h3');
                    if (titleEl) {
                        // 移除旧的序号
                        titleEl.innerHTML = titleEl.innerHTML.replace(/^\d+\.\s*/, '');
                    }
                });
            }

            function updateDisplay() {
                const query = searchInput.value.toLowerCase().trim();
                const sortBy = sortBySelect.value;
                const sortOrder = sortOrderSelect.value;

                let visibleCount = 0;

                papersData.forEach(paper => {
                    let isVisible = true;

                    if (query !== '') {
                        const keywords = query.split(/\s+/).filter(k => k.length > 0);
                        isVisible = keywords.every(keyword => paper.fullText.includes(keyword));
                        
                        if (isVisible) {
                            paper.relevance = keywords.reduce((score, keyword) => {
                                const matches = (paper.fullText.match(new RegExp(keyword, 'g')) || []).length;
                                const titleMatches = (paper.title.toLowerCase().match(new RegExp(keyword, 'g')) || []).length;
                                return score + matches + titleMatches * 3;
                            }, 0);
                        }
                    } else {
                        paper.relevance = 0;
                    }
                    
                    paper.element.classList.toggle('hidden', !isVisible);
                    if (isVisible) visibleCount++;
                });

                if (noResultsDiv) {
                    noResultsDiv.style.display = visibleCount === 0 && query !== '' ? 'block' : 'none';
                }

                const visiblePapers = papersData.filter(p => !p.element.classList.contains('hidden'));
                
                visiblePapers.sort((a, b) => {
                    let valA, valB;
                    switch (sortBy) {
                        case 'date':
                            valA = new Date(a.date);
                            valB = new Date(b.date);
                            break;
                        case 'title':
                            valA = a.title.toLowerCase();
                            valB = b.title.toLowerCase();
                            break;
                        case 'relevance':
                            valA = a.relevance;
                            valB = b.relevance;
                            if (valA === valB) {
                                valA = new Date(a.date);
                                valB = new Date(b.date);
                            }
                            break;
                        default:
                            return 0;
                    }

                    if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
                
                visiblePapers.forEach(paper => {
                    papersContainer.appendChild(paper.element);
                });
                
                // 更新序号
                updatePaperNumbers();
                
                console.log('显示 ' + visibleCount + ' 篇论文，排序: ' + sortBy + ' (' + sortOrder + ')');
            }

            function setupEventListeners() {
                sortBySelect.addEventListener('change', updateDisplay);
                sortOrderSelect.addEventListener('change', updateDisplay);
                
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function() {
                        if (searchInput.value.trim() !== '') {
                            if (sortBySelect.value !== 'relevance') {
                                sortBySelect.value = 'relevance';
                            }
                        }
                        updateDisplay();
                    }, 300);
                });
                
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        searchInput.value = '';
                        sortBySelect.value = 'date';
                        updateDisplay();
                    }
                });
            }

            setTimeout(function() {
                papersData = parsePaperElements();
                if (papersData.length > 0) {
                    setupEventListeners();
                    updateDisplay();
                    console.log('初始化成功！');
                } else {
                    console.error('未找到论文数据');
                }
            }, 200);
        });
        //]]>
      </script>

      <footer class="site-footer">
        {% if site.github.is_project_page %}
          <span class="site-footer-owner"><a href="{{ site.github.repository_url }}">{{ site.github.repository_name }}</a> is maintained by <a href="{{ site.github.owner_url }}">{{ site.github.owner_name }}</a>.</span>
        {% endif %}
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>
  </body>
</html>