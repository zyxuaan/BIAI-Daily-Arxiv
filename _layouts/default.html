<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-US" }}">
  <head>
    <meta charset="utf-8">
    <title>{{ page.title | default: site.title }}</title>
    {% include mathjax.html %}
    {% seo %}
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="icon" href="{{ '/img/paper.png' | relative_url }}" type="image/png" />
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Vollkorn:400,700&display=swap" as="style" type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="{{ '/assets/css/style.css?v=' | append: site.github.build_revision | relative_url }}">
    <style>
      body { font-family: "Vollkorn", serif; }
      h1, h2, h3, h4, h5, h6 { font-family: "Vollkorn", serif; }
      #controls-container {
        margin-bottom: 25px; padding: 15px; background-color: #f8f9fa;
        border-radius: 8px; display: flex; flex-wrap: wrap; align-items: center; gap: 20px;
        border: 1px solid #e9ecef;
      }
      .control-group { display: flex; align-items: center; }
      .control-group label { margin-right: 10px; font-weight: bold; font-size: 0.9em; }
      .control-group select, .control-group input {
        padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px;
        font-size: 0.9em; background-color: #fff;
      }
      #search-input { width: 280px; }
      .paper-wrapper { margin-bottom: 1.5rem; } /* 为每个论文摘要添加外包装 */
      .paper-wrapper.hidden { display: none; } /* 隐藏不匹配的条目 */
    </style>
    {% include head-custom.html %}
  </head>
  <body>
    <a id="skip-to-content" href="#content">Skip to the content.</a>
    <header class="page-header" role="banner">
      <h1 class="project-name">{{ page.title | default: site.title }}</h1>
      <h2 class="project-tagline">{{ page.description | default: site.description }}</h2>
      {% if site.github.is_project_page %}
        <a href="{{ site.github.repository_url }}" class="btn">View on GitHub</a>
      {% endif %}
    </header>

    <main id="content" class="main-content" role="main">
      <div id="controls-container">
        <div class="control-group">
            <label for="sort-by">排序方式:</label>
            <select id="sort-by">
              <option value="relevance">相关度</option>
              <option value="date" selected>发布日期</option>
              <option value="title">标题</option>
            </select>
        </div>
        <div class="control-group">
            <label for="sort-order">排序顺序:</label>
            <select id="sort-order">
              <option value="desc">降序</option>
              <option value="asc">升序</option>
            </select>
        </div>
        <div class="control-group">
            <label for="search-input">搜索:</label>
            <input type="text" id="search-input" placeholder="按关键词搜索标题、作者、摘要...">
        </div>
      </div>
      
      <div id="papers-container">
        {{ content }}
      </div>
      
      <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sortBySelect = document.getElementById('sort-by');
            const sortOrderSelect = document.getElementById('sort-order');
            const searchInput = document.getElementById('search-input');
            const papersContainer = document.getElementById('papers-container');

            if (!papersContainer) return;

            let papersData = [];
            const dateCommentRegex = //;

            // 1. 数据结构化：将DOM元素解析为JS对象数组
            function parsePaperElements() {
                const wrappers = [];
                let currentWrapper = null;
                // 将所有节点包装起来，以h3为分隔
                Array.from(papersContainer.childNodes).forEach(node => {
                    if (node.tagName === 'H3') {
                        if (currentWrapper) wrappers.push(currentWrapper);
                        currentWrapper = document.createElement('div');
                        currentWrapper.className = 'paper-wrapper';
                    }
                    if (currentWrapper) {
                        currentWrapper.appendChild(node.cloneNode(true));
                    }
                });
                if (currentWrapper) wrappers.push(currentWrapper);

                papersContainer.innerHTML = ''; // 清空原始容器
                wrappers.forEach(w => papersContainer.appendChild(w)); // 放入包装好的元素

                return Array.from(papersContainer.querySelectorAll('.paper-wrapper')).map(wrapper => {
                    const titleEl = wrapper.querySelector('h3');
                    const titleText = titleEl ? titleEl.textContent.trim() : '';
                    const fullText = wrapper.textContent.toLowerCase();
                    const dateMatch = wrapper.innerHTML.match(dateCommentRegex);
                    const date = dateMatch ? dateMatch[1] : '1970-01-01';
                    
                    return {
                        element: wrapper,
                        title: titleText,
                        date: date,
                        fullText: fullText,
                        relevance: 0
                    };
                });
            }

            // 2. 核心功能：搜索、排序和渲染
            function updateDisplay() {
                const query = searchInput.value.toLowerCase().trim();
                const sortBy = sortBySelect.value;
                const sortOrder = sortOrderSelect.value;

                // A. 过滤和计算相关度
                papersData.forEach(paper => {
                    const isVisible = query === '' || paper.fullText.includes(query);
                    paper.element.classList.toggle('hidden', !isVisible);

                    if (query !== '') {
                        paper.relevance = (paper.fullText.match(new RegExp(query, 'g')) || []).length;
                    } else {
                        paper.relevance = 0;
                    }
                });

                // B. 排序
                const visiblePapers = papersData.filter(p => !p.element.classList.contains('hidden'));
                
                visiblePapers.sort((a, b) => {
                    let valA, valB;
                    switch (sortBy) {
                        case 'date':
                            valA = new Date(a.date);
                            valB = new Date(b.date);
                            break;
                        case 'title':
                            valA = a.title;
                            valB = b.title;
                            break;
                        case 'relevance':
                            valA = a.relevance;
                            valB = b.relevance;
                            break;
                        default:
                            return 0;
                    }

                    if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
                
                // C. 重新渲染到DOM
                visiblePapers.forEach(paper => {
                    papersContainer.appendChild(paper.element);
                });
            }

            // 3. 事件监听器
            function setupEventListeners() {
                sortBySelect.addEventListener('change', updateDisplay);
                sortOrderSelect.addEventListener('change', updateDisplay);
                
                searchInput.addEventListener('input', () => {
                    if (searchInput.value.trim() !== '') {
                        sortBySelect.value = 'relevance'; // 搜索时自动切换为相关度排序
                    } else {
                        sortBySelect.value = 'date'; // 清空搜索时恢复为日期排序
                    }
                    updateDisplay();
                });
            }

            // 4. 初始化
            papersData = parsePaperElements();
            setupEventListeners();
            updateDisplay(); // 页面加载时执行一次，按默认设置排序
        });
      </script>

      <footer class="site-footer">
        {% if site.github.is_project_page %}
          <span class="site-footer-owner"><a href="{{ site.github.repository_url }}">{{ site.github.repository_name }}</a> is maintained by <a href="{{ site.github.owner_url }}">{{ site.github.owner_name }}</a>.</span>
        {% endif %}
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>
  </body>
</html>